# YMM4 自動化 PoC 計画 (Y3)

最終更新: 2025-12-10
関連ドキュメント: `docs/ymm4_integration_arch.md`, `docs/ymm4_export_spec.md`, `docs/backlog.md`

**重要**: 本ドキュメントはプラグインAPI優先アプローチに更新されました。AutoHotkeyは代替手段として位置づけます。

---

## 1. 目的とスコープ

- 本ドキュメントの目的:
  - フェーズ Y3 (`Y3-ymm4-poc-plan`) に対応する、YMM4 自動化 PoC の **具体的なシナリオと前提条件** を整理すること。
  - 既存の AutoHotkey/YMM4 連携タスク（主に C3-3/C3-4/C3-5 系）を棚卸しし、
    「どこからどこまでを最初の PoC として扱うか」を明確にすること。
- 対象とする範囲:
  - **プラグインAPI優先**: YMM4の.NETプラグインAPIを活用（AutoHotkeyは代替手段）。
  - OS: Windows + YMM4 + .NET 9 SDK が導入済みであるローカル環境。
  - ゴールは **YMM4 内で台本 CSV を用いて音声(WAV)を一括生成し、所定フォルダに書き出すまで** の一連のフロー。
- 本ドキュメントでは **実装手順そのものは書かず**、Y4/Y5 で実装する際の設計インプットを定義する。

---

## 2. 現状把握: YMM4 連携方式の比較

### 2.1 プラグインAPIアプローチ（優先）

- **YMM4 Plugin API**: https://ymm-api-docs.vercel.app/
- 特徴:
  - C#/.NET 9 ベースのプラグイン開発
  - YMM4の内部機能に直接アクセス可能
  - GUI操作不要で安定性が高い
  - 拡張性・メンテナンス性に優れる
- 利用可能なプラグインインターフェース:
  - `IPlugin` - 基本プラグイン情報
  - `IVoicePlugin` - ボイス生成
  - `ITextCompletionPlugin` - テキスト補完・校正（LLM連携可能）
  - `IAudioFileSourcePlugin` - 外部音声ファイルソース
  - `IVideoFileSourcePlugin` - 外部動画ファイルソース
- プロジェクト: `ymm4-plugin/` ディレクトリにスケルトン実装済み
- 参考リソース:
  - [プラグインサンプル集](https://github.com/manju-summoner/YukkuriMovieMaker4PluginSamples)

### 2.2 AutoHotkeyアプローチ（代替手段）

- 仕様: `docs/ymm4_export_spec.md`
- 現状の機能:
  - YMM4の起動／ウィンドウ検出
  - 音声・タイムラインのインポート
  - 書き出しダイアログの操作
- 制約:
  - GUI座標依存のため安定性にリスク
  - YMM4のUIアップデートで動作しなくなる可能性
  - デバッグが困難
- 使用ケース:
  - プラグインAPIでは実現困難な操作（特定UIダイアログなど）
  - 緊急時の回避策

### 2.3 現状のギャップ

- YMM4の「台本CSV読み込み」や「キャラクターごとのゆっくり音声生成」操作は未自動化。
- 書き出されたWAVを `audio_dir` 命名規則（`001.wav` ...）に揃える処理は未設計（Y5 担当）。

---

## 3. PoC のゴール定義

### 3.1 成功条件（Accept Criteria）

1. **入力条件**
   - 台本 CSV が `docs/spec_csv_input_format.md` の仕様に沿っていること（speaker/text 2列形式）。
   - YMM4 用のテンプレートプロジェクトが 1つ決まっていること。
   - AutoHotkey がインストール済みで、YMM4 の起動とウィンドウ検出が可能であること。

2. **PoC 実行フロー（理想形）**
   - ユーザーが以下の情報を指定する:
     - 台本 CSV パス
     - 出力先フォルダ（YMM4 で書き出す WAV の格納先）
     - 使用する YMM4 テンプレートプロジェクトパス
   - AutoHotkey スクリプト（または AHK + 補助Pythonスクリプト）が次を自動化:
     1. YMM4 を起動し、テンプレートプロジェクトを開く。
     2. 台本 CSV を読み込み、タイムラインにテキスト＋キャラクターを反映する。
     3. ゆっくり音声を一括生成する（YMM4 側の「音声生成」機能を利用）。
     4. 各行に対応する音声を WAV として指定フォルダに書き出す。

3. **PoC の評価指標**
   - 少なくとも 1 つのサンプル CSV（例: `スリランカ.csv`）について、
     - 全行に対応する WAV が書き出されること。
     - 失敗時にログ／メッセージから原因を追跡できること。
   - YMM4 側のちょっとした UI 変更（ボタン位置など）があっても、
     - スクリプトの修正ポイントが限定的であること（ハードコード座標を最小限に）。

### 3.2 非ゴール（今回の PoC ではやらないこと）

- 本アプリからのワンクリック呼び出し（Web UI 連携）。
- マルチプロジェクト同時処理や、きめ細かな失敗時再開機能。
- 完全なプロダクション品質のプラグイン（まずはPoC）。

---

## 4. 候補シナリオと優先順位

### 4.0 シナリオ Zero: プラグインAPI動作確認（最優先）

- 概要:
  - `ymm4-plugin/` のスケルトンプロジェクトがYMM4に正常にロードされることを確認。
  - 最小限のプラグイン（`IPlugin`実装のみ）でYMM4の「プラグイン一覧」に表示されることを検証。
- 前提:
  - .NET 9 SDKインストール済み
  - YMM4 v4.33.0.0以降インストール済み
  - `Directory.Build.props` にYMM4インストールパスを設定
- PoC で検証したいポイント:
  - ビルドが成功し、DLLがプラグインフォルダにコピーされるか
  - YMM4起動時にプラグインがロードされるか
  - エラー時のデバッグ方法の確立
- 想定アウトプット:
  - `NLMSlidePlugin.dll` がYMM4のプラグイン一覧に表示される
  - ビルド・デプロイ手順書

### 4.1 シナリオ A: プラグインによるテキストインポート

- 概要:
  - `ITextCompletionPlugin` または独自インターフェースを使用し、
    外部CSVファイルのテキストをYMM4タイムラインに取り込む。
- 前提:
  - シナリオZeroが完了していること
  - YMM4の内部データ構造（タイムラインアイテム等）が把握できていること
- PoC で検証したいポイント:
  - プラグインからYMM4の内部APIを呼び出せるか
  - タイムライン操作が可能か
- 想定アウトプット:
  - CSVの行がYMM4タイムラインにテキストアイテムとして追加される

### 4.2 シナリオ B: 既存 YMM4 プロジェクトに対する追加入力テスト

- 概要:
  - すでに手動である程度セットアップされた YMM4 プロジェクトを開き、
    一部テキスト行のみを対象に音声生成〜書き出しを自動化する。
- 目的:
  - 既存プロジェクトに対する「部分的な再生成」や「差し替え」の可能性を検証する。
- 優先度:
  - シナリオ A が安定してからの拡張として扱う（今回の Y3 ではアイデア列挙のみに留める）。

### 4.3 シナリオ C: 書き出し結果と CSV 行の対応表生成

- 概要:
  - シナリオ A/B のいずれでも、YMM4 書き出し結果と元 CSV 行番号の対応を表形式で出力する。
- 用途:
  - Y5 の `YMM4 → audio_dir ブリッジ` 実装時に、
    どのファイルがどの行に対応するかをプログラム的に判断しやすくする。
- 実現方法の例:
  - 書き出しダイアログの設定や、YMM4 のログファイルを活用。
  - あるいは、書き出しファイル名に行番号を含める（`line001_*.wav` など）。

---

## 5. 実装タスクへの落とし込み（Y4/Y5 への橋渡し）

### 5.1 Y4-ymm4-poc-impl に渡すタスク案（プラグインAPI優先）

#### Phase 1: プラグイン基盤（優先）

- C# プラグインプロジェクト構成:
  - `ymm4-plugin/NLMSlidePlugin.csproj` - メインプロジェクト
  - `ymm4-plugin/PluginInfo.cs` - プラグインメタデータ
  - `ymm4-plugin/VoicePlugin/` - ボイス関連
  - `ymm4-plugin/TextCompletionPlugin/` - テキスト補完関連
- 設定項目:
  - `Directory.Build.props` - YMM4インストールパス
  - プラグイン設定（将来的にはYMM4の設定UIから）

#### Phase 2: 機能実装

- CSV読み込み機能
- タイムラインアイテム生成
- 音声生成連携
- WAV書き出し

#### 代替手段: AutoHotkey（必要時のみ）

- AHK スクリプト構成案:
  - メインスクリプト: `ymm4_generate_audio.ahk`（仮）
  - Python呼び出しラッパー（任意）
- 設定項目:
  - YMM4 実行ファイルパス
  - テンプレートプロジェクトパス
  - 台本 CSV パス
  - 書き出し先ディレクトリ

### 5.2 Y5-ymm4-bridge に渡すタスク案

- 新規スクリプト `scripts/ymm4_audio_bridge.py`（仮）の想定仕様:
  - 入力:
    - YMM4 が書き出した WAV が格納されたディレクトリ
    - 台本 CSV
    - （任意）YMM4 側で採用したファイル命名規則に関するメタ情報
  - 出力:
    - `audio_dir/` 以下に `001.wav`, `002.wav`, ... を配置
    - 対応表 CSV（`line_number, source_file, target_file` など）
  - エラー条件:
    - 行数とファイル数が一致しない場合の警告・停止条件など。

---

## 6. 次ステップ（Y3 タスク完了条件）

Y3 (`Y3-ymm4-poc-plan`) を「完了」とみなすための条件は以下とする:

1. 本ドキュメントに記載した **PoC ゴール・非ゴール・シナリオ(A/B/C)** がレビューされ、
   大きな方向性について合意が取れていること。
2. Y4/Y5 に渡すべきタスク粒度（どのスクリプトを新設し、どの設定項目を持たせるか）が、
   少なくとも本ドキュメントレベルで整理されていること。
3. バックログ (`docs/backlog.md`) の Y3/Y4/Y5 説明と、本ドキュメントの内容に齟齬がないこと。

これらが満たされた段階で、Y3 を完了として Y4-ymm4-poc-impl (実装) に進むことを想定する。
