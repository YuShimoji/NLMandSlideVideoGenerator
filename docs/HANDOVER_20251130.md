# 作業引き継ぎメモ

## 📅 作業日: 2025年11月30日

## ✅ 完了タスク

### バグ修正

| ファイル | 変更内容 |
|----------|----------|
| `src/core/pipeline.py` | `run_csv_timeline` をWAV専用に戻し仕様と整合（ログ強化は維持） |
| `src/core/editing/ymm4_backend.py` | `import sys` 追加、`generate_ymm4_ahk.py` へのパス修正 |

### ドキュメント整備

| ファイル | 変更内容 |
|----------|----------|
| `docs/ymm4_export_spec.md` | 空だったファイルを現状実装ベースで再作成（全364行） |
| `docs/backlog.md` | フェーズC進行中、完了タスク追加、次アクション更新 |

### YMM4 ワークフロー設計と現状の乖離検証

**設計意図（理想形）**:
```
ScriptBundle + AudioInfo + YMM4 Template
    ↓
TimelinePlanner → TimelinePlan
    ↓
YMM4EditingBackend
  1. テンプレート .y4mmp 複製
  2. YMM4 API でタイムライン挿入
  3. YMM4 API で書き出し
     └─ 失敗時: AutoHotkey でGUI操作
        └─ 失敗時: MoviePy フォールバック
    ↓
VideoInfo + YMM4 Project + TimelinePlan
```

**現状実装**:
```
timeline_plan + audio + slides + transcript
    ↓
YMM4EditingBackend
  1. プロジェクトディレクトリ作成
  2. テンプレート .y4mmp 複製
  3. timeline_plan.json 出力
  4. slides_payload.json 出力
  5. CSV / 音声アセットコピー
  6. AutoHotkey スクリプト生成 (PoC)
  7. **常に MoviePy フォールバックで動画生成**
  8. render_metadata.json 出力
    ↓
VideoInfo (MoviePy生成) + YMM4 Project (手動編集用)
```

**ギャップサマリ**:

| 設計項目 | 設計意図 | 現状 | ギャップ |
|----------|----------|------|----------|
| YMM4 API 連携 | API 経由でタイムライン挿入 | 未実装 | 大 |
| 書き出し方式 | API → AHK → MoviePy の段階フォールバック | 常に MoviePy | 中 |
| AutoHotkey | GUI 操作で書き出し | PoC（プレースホルダー） | 中 |
| テンプレート差分 | 差分適用でカスタマイズ | プロトタイプのみ | 中 |
| アセット管理 | timeline_plan/slides_payload 出力 | 実装済み | なし |

**結論**: 現状は「YMM4プロジェクト出力 + MoviePyフォールバック」という最小限の統合。
設計が意図した「YMM4 API による本格的な編集自動化」には至っていないが、
ステップワイズ実装としては適切。

---

## 🔄 次回作業予定

### 推奨優先順位

| 優先度 | タスク | 概要 | 参照ファイル |
|--------|--------|------|--------------|
| 高 | A-4 動画合成・エフェクト実装 | PPTX抽出、FFmpeg字幕合成 | `video_editor/video_composer.py` |
| 高 | B-1 ジョブ管理機能 | ステータス追跡・キャンセル | `web/logic/pipeline_manager.py` |
| 中 | C-2-1 AutoHotkey安定化 | PoC → 実用レベル | `scripts/generate_ymm4_ahk.py` |

### 保留中

- **A-1 NotebookLM API**: 公式API待ち
- **C-2-4 YMM4 REST API**: 調査段階（https://ymm-api-docs.vercel.app/）

---

## 🧪 テスト実行手順

### コンパイルチェック

```cmd
cd C:\Users\thank\Storage\Media Contents Projects\NLMandSlideVideoGenerator
python -m compileall src -q
```

**期待結果**: 終了コード 0

### CSVパイプラインテスト

```cmd
python -m pytest tests/test_csv_pipeline_mode.py -v
```

**期待結果**: 3/3 成功

---

## 📁 今回の主要変更ファイル

```
NLMandSlideVideoGenerator/
├── src/
│   └── core/
│       ├── pipeline.py              # WAV専用に修正
│       └── editing/
│           └── ymm4_backend.py      # sys import + パス修正
└── docs/
    ├── ymm4_export_spec.md          # 再作成（364行）
    ├── backlog.md                   # 更新
    └── HANDOVER_20251130.md         # 本ファイル
```

---

## ⚠️ 注意事項

1. **WAV検出**: `run_csv_timeline` は WAV ファイル (.wav) のみを検出する仕様
   - 他のフォーマット（mp3, m4a等）は非対応
   - TTSバッチスクリプトで `001.wav`, `002.wav`, ... を生成する前提

2. **YMM4 AutoHotkey**: PoC段階
   - スクリプトは生成されるが、YMM4 UIへの具体的操作はプレースホルダー
   - 手動でのYMM4編集を前提としたワークフロー

3. **MoviePyフォールバック**: 常に実行される
   - YMM4プロジェクトは手動編集用として出力
   - 自動書き出し機能は未実装

---

## 📊 プロジェクト現状サマリ

### フェーズ状態

| フェーズ | 状態 |
|----------|------|
| A (コア機能) | 🟢 進行中（A-3完了） |
| B (Web/API) | ⚪ 待機 |
| C (CSV/YMM4) | 🟢 進行中（基盤完了） |

### C フェーズ詳細

| 機能 | 状態 |
|------|------|
| CSVタイムラインモード | ✅ 実装済み |
| SofTalk/AquesTalk TTS連携 | ✅ 実装済み |
| YMM4プロジェクト出力 | ✅ 実装済み |
| AutoHotkey連携 | ⚠️ PoC |
| YMM4 API連携 | ❌ 未実装 |

---

**作業引き継ぎ完了 - 2025年11月30日**
