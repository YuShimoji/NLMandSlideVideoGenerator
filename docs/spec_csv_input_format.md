# CSV入力フォーマット仕様書

CSVタイムラインパイプラインで使用する入力フォーマットの仕様です。

---

## 1. CSVフォーマット

### 1.1 基本形式

```csv
{話者名},{テロップテキスト}
```

**例:**
```csv
Speaker1,これは1行目のテロップです
Speaker2,これは2行目のテロップです
ナレーター,3行目は長いテロップで自動的に分割されます
```

### 1.2 列定義

| 列番号 | 名前 | 必須 | 説明 |
|--------|------|------|------|
| A (1列目) | speaker | ○ | 話者名。任意の文字列 |
| B (2列目) | text | ○ | テロップテキスト |

### 1.3 制約

- **エンコーディング**: UTF-8 (BOMなし推奨)
- **区切り文字**: カンマ (`,`)
- **ヘッダー行**: なし（1行目からデータ）
- **改行**: LF または CRLF
- **クォート**: テキストにカンマを含む場合はダブルクォートで囲む

### 1.4 話者名の仕様

話者名は任意の文字列を指定できます。

**推奨パターン:**
- `Speaker1`, `Speaker2` - 汎用
- `ナレーター`, `解説` - 日本語
- `ずんだもん`, `四国めたん` - キャラクター名

**YMM4連携時の注意:**
話者名はYMM4のキャラクター設定と紐づけられます。

### 1.5 テキストの仕様

- **最大文字数**: 制限なし（長文は自動分割）
- **自動分割**: デフォルト60文字で分割
- **改行**: `\n` はサポートされません（1行=1セグメント）

### 1.6 長文の自動分割

60文字を超える行は、句読点で自動的に分割されます。

**入力:**
```csv
Speaker1,これは非常に長いテロップで、句読点で区切られています。複数のスライドに分割されます。
```

**処理後:**
```
スライド1: "これは非常に長いテロップで、"
スライド2: "句読点で区切られています。"
スライド3: "複数のスライドに分割されます。"
```

**分割ルール:**
1. 句点（`。`）で分割を優先
2. 読点（`、`）で分割
3. 上記がない場合は文字数で強制分割

**設定:**
```python
# settings.py または CLIオプション
SLIDES_SETTINGS["max_chars_per_slide"] = 60
```

---

## 2. 音声ファイルフォーマット

### 2.1 ディレクトリ構造

```
audio_folder/
├── 001.wav
├── 002.wav
├── 003.wav
└── ...
```

### 2.2 ファイル命名規則

| パターン | 例 | 説明 |
|----------|-----|------|
| `NNN.wav` | `001.wav`, `002.wav` | 3桁ゼロ埋め (推奨) |
| `N.wav` | `1.wav`, `2.wav` | ゼロ埋めなし (対応) |

**検索順序:**
1. `001.wav` (3桁ゼロ埋め)
2. `1.wav` (ゼロ埋めなし)

### 2.3 対応フォーマット

| フォーマット | 拡張子 | 推奨 |
|-------------|--------|------|
| WAV (PCM) | `.wav` | ○ |
| MP3 | `.mp3` | △ |

**推奨スペック:**
- サンプルレート: 44100Hz または 48000Hz
- ビット深度: 16bit
- チャンネル: モノラル または ステレオ

### 2.4 CSVとの対応

CSVの行番号と音声ファイル番号は1対1で対応します。

```
CSV行1 → 001.wav
CSV行2 → 002.wav
CSV行3 → 003.wav
```

**注意:** 長文分割後も、元の行番号に対応する音声ファイルが使用されます。

---

## 3. 出力フォーマット

### 3.1 動画出力

- **フォーマット**: MP4 (H.264 + AAC)
- **解像度**: 1080p / 720p / 480p (選択可能)
- **フレームレート**: 30fps (デフォルト)

### 3.2 字幕出力

| フォーマット | ファイル | 用途 |
|-------------|---------|------|
| SRT | `{topic}_subtitles.srt` | 汎用字幕 |
| VTT | `{topic}_subtitles.vtt` | Web用 |
| ASS | `{topic}_subtitles_default.ass` | 装飾付き字幕 |

### 3.3 YMM4出力 (オプション)

```
ymm4_project_XXXXXX/
├── project.y4mmp        # YMM4プロジェクトファイル
├── slides_payload.json  # スライド情報
├── timeline_plan.json   # タイムライン計画
└── ymm4_automation.ahk  # AutoHotkeyスクリプト
```

---

## 4. サンプルファイル

### 4.1 最小構成のサンプル

**timeline.csv:**
```csv
Speaker1,こんにちは
Speaker2,こんにちは、今日もよろしくお願いします
Speaker1,では始めましょう
```

**audio/:**
```
001.wav  (「こんにちは」の音声)
002.wav  (「こんにちは、今日もよろしくお願いします」の音声)
003.wav  (「では始めましょう」の音声)
```

**実行:**
```bash
python scripts/run_csv_pipeline.py --csv timeline.csv --audio-dir audio/
```

### 4.2 2話者対話のサンプル

**dialogue.csv:**
```csv
ずんだもん,今日はAI技術について解説するのだ
四国めたん,ずんだもん、詳しく教えて
ずんだもん,まず生成AIの基本から説明するのだ
四国めたん,なるほど、分かりやすいね
ずんだもん,これがAI技術の基本なのだ
```

---

## 5. バリデーション

パイプライン実行時に以下のチェックが行われます:

| チェック項目 | エラー時の動作 |
|-------------|---------------|
| CSVファイルの存在 | エラー終了 |
| 音声ディレクトリの存在 | エラー終了 |
| 音声ファイルの存在 | 警告ログ、処理継続 |
| UTF-8エンコーディング | 警告ログ、処理継続 |

---

## 6. 関連ドキュメント

- `docs/user_guide_manual_workflow.md` - ユーザー向けワークフローガイド
- `docs/tts_batch_softalk_aquestalk.md` - 音声生成バッチ
- `docs/ymm4_export_spec.md` - YMM4エクスポート仕様
