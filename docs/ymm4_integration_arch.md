# YMM4 連携アーキテクチャ設計

最終更新: 2025-12-10
対象バージョン: **プラグインAPI優先** CSV タイムラインモード / YMM4 エクスポート基盤完了後

**重要変更**: YMM4 プラグインAPI（.NET）を優先するアプローチに更新。AutoHotkeyは代替手段として位置づけ。

---

## 1. 目的とスコープ

このドキュメントの目的は、次の観点で **「YMM4 を中心に据えた最終フロー」** を明文化し、
今後の実装タスク（Y2〜Y5, C-2, C-3 系）に対する **設計上の基準点（SSOT）** を提供することです。

- CSV タイムラインモードと YMM4 の役割分担を明確にする
- 「どこまで自動化し、どこからユーザー操作に任せるか」を段階的に定義する
- 今後実装するプラグイン／スクリプト／AutoHotkey（代替）などの **接続ポイント** を整理する
- 既存ドキュメント（`backlog.md`, `ymm4_export_spec.md`, `user_guide_manual_workflow.md` 等）との整合を取る

本ドキュメントは **YMM4プラグインAPI（.NET）を優先したYMM4連携アーキテクチャ** を対象とします。

**API 情報**:
- ドキュメント: https://ymm-api-docs.vercel.app/
- サンプルリポジトリ: https://github.com/manju-summoner/YukkuriMovieMaker4PluginSamples
- プロジェクト: `ymm4-plugin/` ディレクトリにスケルトン実装済み

---

## 2. 現状のおさらい

### 2.1 CSV タイムラインモード

- 前提:
  - `csv` + 行ごとの `wav` (`001.wav`, `002.wav`, ...) が揃っていること
  - どの TTS エンジンで WAV を生成したかは問わない
- 主な処理の流れ（既存実装）:
  - `scripts/run_csv_pipeline.py` → `src/core/pipeline.py::run_csv_timeline()`
  - WAV 検出 → AudioInfo 作成 → TranscriptInfo 読み込み → スライド・動画生成 → YMM4 プロジェクト書き出し（任意）
- 参考ドキュメント:
  - `docs/spec_csv_input_format.md`
  - `docs/tts_batch_softalk_aquestalk.md`
  - `docs/ymm4_export_spec.md`

### 2.2 YMM4 エクスポート（既存機能）

- `run_csv_timeline()` は、最終成果物として以下を出力可能:
  - 合成済み動画
  - 字幕ファイル (SRT/ASS/VTT)
  - YMM4 プロジェクトファイル（タイムライン情報を含む）
- `docs/ymm4_export_spec.md` に、YMM4 プロジェクト出力の仕様・テンプレート差分の考え方が整理済み。

### 2.3 SofTalk/AquesTalk の位置づけ（整理済み）

- `docs/tts_batch_softalk_aquestalk.md` / `docs/backlog.md` に記載の通り:
  - SofTalk/AquesTalk 連携は、環境依存が大きく、
    **「動作すれば便利な上級者向けオプション」** として扱う。
  - 主フローは「CSV + WAV が揃っている」ことだけを前提とし、
    YMM4 / NotebookLM / 他クラウド TTS / AquesTalk Player 等、任意の手段を許容する。

---

## 3. 目標とする YMM4 中心フロー

### 3.1 ゴールイメージ（高レベル）

YMM4 を「ゆっくり系音声とタイムライン編集のハブ」として位置づけた、
エンドツーエンドのゴールイメージは次のとおりです。

```text
[情報収集/台本生成 (NotebookLM/Gemini 等)]
        ↓ 台本CSV
[YMM4 プロジェクト (テンプレート + 台本CSV)]
        ↓ 音声生成 (YMM4 内部機能)
[WAV 一式 or 完成動画]
        ↓
[本 CSV タイムラインパイプライン]
        ↓
[最終動画 + 字幕 + サムネ + メタデータ + (YMM4 プロジェクト)]
```

- **台本生成フェーズ** は将来 NotebookLM/Gemini API などで自動化されるが、
  本ドキュメントでは「CSV が既にある」状態を前提とする。
- **YMM4 フェーズ** では、以下の 2 パターンを想定する:
  - パターン A: YMM4 で **音声 (WAV)** を生成し、本パイプラインが動画を生成する
  - パターン B: 本パイプラインが YMM4 プロジェクトを出力し、YMM4 で最終動画を書き出す
- 現時点の重点は **パターン A（YMM4 → WAV → CSV パイプライン）** の整理と橋渡し設計である。

### 3.2 パターン A: YMM4 で音声生成 → CSV パイプライン

- 入力:
  - 台本 CSV
  - YMM4 テンプレートプロジェクト（フォルダ構成 / 初期設定 含む）
- 中間状態:
  - YMM4 プロジェクト内に、各行に対応する字幕・音声オブジェクトが作成される
- 出力:
  - `audio_dir` 配下に `001.wav`, `002.wav`, ... が生成される
  - （任意）YMM4 プロジェクトも保存される
- その後:
  - `run_csv_pipeline.py --audio-dir <audio_dir>` で本パイプラインを実行する。

### 3.3 パターン B: CSV パイプライン → YMM4 プロジェクト

- 入力:
  - CSV + WAV
- 処理:
  - 本パイプラインが動画・字幕・YMM4 プロジェクトを生成
- 出力:
  - YMM4 で読み込めるプロジェクトファイル（`ymm4_export_spec.md` 参照）
- 用途:
  - YMM4 側での細かなタイムライン調整・エフェクト追加・書き出し設定変更など

本ドキュメントで新たに設計する範囲は、主に **3.2 の実現方法（YMM4 から audio_dir まで）** である。

---

## 4. コンポーネントと責務分担

### 4.1 主なコンポーネント一覧

| コンポーネント | 役割 | 実装ステータス |
|--------------|------|----------------|
| 台本 CSV 生成 | NotebookLM/Gemini 等で台本を作り CSV 化する | 設計済み (A 系タスク) |
| YMM4 テンプレートプロジェクト | 台本 CSV をインポートするためのベースプロジェクト | 概念設計済み (`ymm4_export_spec.md`) |
| YMM4 プラグイン (優先) | .NETプラグインAPIでYMM4内部機能にアクセス | **スケルトン実装済み** (`ymm4-plugin/`) |
| YMM4 操作自動化 (AutoHotkey) | GUI操作自動化（代替手段） | C2/C3-4 系タスク |
| YMM4 出力音声 → audio_dir ブリッジ | YMM4 が書き出した WAV を `audio_dir` の `001.wav` 形式に並べる | **本ドキュメントで設計し、Y5 で実装** |
| CSV タイムラインパイプライン | `csv` + `audio_dir` から動画/字幕/サムネ/メタデータを生成 | 実装済み (C-1 系タスク完了) |

### 4.2 責務境界の原則

- **YMM4 側**
  - 台本内容の編集
  - 音声合成（ゆっくり系音声の生成）
  - タイムライン編集
- **本アプリ側**
  - CSV タイムラインに基づくスライド/動画/字幕生成
  - YouTube など外部プラットフォーム向けのメタデータ生成
  - YMM4 プロジェクトのテンプレート生成・差分反映（将来的には）
- **橋渡しスクリプト (YMM4 → audio_dir)**
  - YMM4 が出力した WAV を検出し、
    `001.wav`, `002.wav`, ... という命名規則に従って `audio_dir` に配置する
  - CSV の行順と WAV ファイルの対応関係を保証する

---

## 5. フェーズ別ロードマップとタスク対応

ここでは、既存のバックログ (C-2, C-3 系) と、今回の Y2〜Y5 タスクを対応付けます。

### 5.1 Y2: アーキテクチャ設計（本ドキュメント）

- 目的:
  - YMM4 中心フローの全体像と責務境界を明文化し、
    以降の PoC / 実装タスクの設計上の前提を固める。
- 対応する既存タスク:
  - C-2 系全体（YMM4 エクスポート・テンプレート差分）
  - C3-4 系の「AutoHotkey 実用化」タスク群の上位設計
- 成果物:
  - 本ドキュメント `docs/ymm4_integration_arch.md`
  - `docs/backlog.md` からの参照リンク

### 5.2 Y3: YMM4 自動化 PoC 計画

- 主な検討項目:
  - どのシナリオを **最初の PoC** とするか
    - 例: 「YMM4 起動 → 台本 CSV インポート → 音声生成 → WAV フォルダ書き出し」
  - 手動操作と自動操作の切り分け
    - 手動: プロジェクトテンプレの選択、微調整
    - 自動: CSV インポート、音声一括生成、WAV 書き出し
  - 必要な前提条件
    - YMM4 のバージョン・想定インストールパス
    - プロジェクトテンプレートの配置場所
- 成果物（想定）:
  - PoC 用の最小ステップを列挙したドキュメント（別ファイル）
  - AutoHotkey スクリプト構成案（ファイル分割方針、命名規則など）

### 5.3 Y4: YMM4 自動化 PoC 実装

#### 優先: プラグインAPIアプローチ

- 実装範囲:
  - `ymm4-plugin/` のスケルトンを完成させ、YMM4にロード確認
  - `IPlugin` 実装でYMM4の「プラグイン一覧」に表示されることを検証
  - 必要に応じて `IVoicePlugin`, `ITextCompletionPlugin` 等を実装

- フロー:

    ```text
    [プラグインビルド]
        ↓
    [DLLがYMM4プラグインフォルダにコピー]
        ↓
    [YMM4起動時にプラグインロード]
        ↓
    [プラグイン機能でCSVインポート/音声生成/WAV書き出し]
    ```

#### 代替手段: AutoHotkey（プラグインで実現困難な場合のみ）

- GUI操作自動化で次のフローを半自動化:
  - YMM4起動→テンプレートオープン→CSVインポート→音声生成→WAV書き出し
- 制約:
  - GUI座標依存のため安定性が低い
  - YMM4のUIアップデートで動作しなくなる可能性あり

### 5.4 Y5: YMM4 出力音声と CSV パイプラインの橋渡し

- 目的:
  - YMM4 が出力した WAV ファイル群を、本アプリの `audio_dir` 仕様に合わせて整形する。
- 想定仕様:
  - 入力:
    - YMM4 プロジェクトの出力ディレクトリ
    - 対応する台本 CSV
  - 出力:
    - `audio_dir` ディレクトリ
      - `001.wav`, `002.wav`, ... が CSV の行順に並ぶ
  - 処理例:
    - YMM4 側の書き出し命名規則（例: `voice_0001.wav` など）を解析し、
      CSV の行番号とマッピングする
    - 必要に応じて、マッピング用の補助 CSV を出力する
- 実装候補:
  - 新規スクリプト: `scripts/ymm4_audio_bridge.py`（仮称）
  - 既存 CLI との連携:
    - `run_csv_pipeline.py` 実行前にこのスクリプトを手動で実行する

---

## 6. 既存コードへのフックポイント

将来の実装時に、どのファイル／関数を編集するかの目安をここにまとめます。

### 6.1 CSV パイプライン関連

- `scripts/run_csv_pipeline.py`
  - 役割: CSV タイムラインパイプラインの CLI エントリポイント
  - YMM4 連携に関する方針:
    - 当面は **YMM4 から WAV を用意した後に実行するだけ** とし、
      直接 YMM4 を操作する処理は入れない。
- `src/core/pipeline.py::run_csv_timeline()`
  - 役割: CSV + WAV から動画/字幕/プロジェクトを生成
  - 方針:
    - `audio_dir` の仕様を変更しない（`001.wav` 形式を維持）
    - YMM4 用の追加フックが必要な場合は、`export_outputs` 周辺でオプションを拡張する

### 6.2 YMM4 エクスポート関連

- `docs/ymm4_export_spec.md`
  - すでに YMM4 プロジェクト出力の仕様が定義されているため、
    - 「パターン B: CSV パイプライン → YMM4 プロジェクト」についてはこのドキュメントを参照する。
- 将来のコード変更候補:
  - `src/slides/slide_generator.py` または専用モジュールに
    「YMM4 用テンプレート差分適用ロジック」を集約する案がある。

### 6.3 YMM4 自動化・橋渡しスクリプト

- AutoHotkey スクリプト群（リポジトリ内または別リポジトリ）
  - C3-4 系タスクに対応。
  - 本アプリとは「コマンドライン経由」「フォルダ監視」などで緩く連携する想定。
- `scripts/ymm4_audio_bridge.py`（仮）
  - 役割: YMM4 の書き出し結果 → `audio_dir` 形式への変換
  - 本パイプラインの外側で実行し、`run_csv_pipeline.py` に入力を渡す。

---

## 7. 制約・オープンな論点

- **YMM4 の仕様依存**
  - バージョン違いや UI 変更により AutoHotkey スクリプトが壊れるリスクがある。
  - 書き出し命名規則が変更された場合、橋渡しスクリプトのロジックも更新が必要。
- **REST API の有無**
  - 現時点では YMM4 に安定した公開 REST API がない前提とする。
  - 今後 API が提供された場合、
    - C3-1/C3-2 タスクとして「REST API クライアント / タイムライン挿入」を再設計・実装する。
- **自動化レベルの段階的向上**
  - 初期フェーズでは「手動操作 + 補助スクリプト」とし、
    - 失敗時の復帰がしやすい形を優先する。
  - フィードバックを踏まえつつ、段階的に自動化範囲を広げる。

---

## 8. 今後のドキュメント更新ポリシー

- 本ドキュメントは YMM4 連携に関する **設計レベルの SSOT** として扱う。
- 実装タスクの進捗に応じて、次のように更新する:
  - Y3 完了時: PoC シナリオと実験結果を簡潔に追記
  - Y4 完了時: 使用する AutoHotkey / スクリプト群の構成図・呼び出し例を追記
  - Y5 完了時: YMM4 → audio_dir ブリッジの入出力仕様とサンプルを追記
- 他ドキュメントとの役割分担:
  - `backlog.md`: タスク一覧と優先度・状態管理
  - `user_guide_manual_workflow.md`: エンドユーザー向け手順書
  - `ymm4_export_spec.md`: YMM4 プロジェクト出力仕様
  - `tts_batch_softalk_aquestalk.md`: ローカル TTS オプションの仕様

以上により、YMM4 中心フローの設計をコード実装に先立って固定し、
以降の実装タスク (Y3〜Y5, C-2/C-3 系) を安全に進められる状態とします。
