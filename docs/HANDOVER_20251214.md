# 作業申し送り (2025-12-14)

## 1. 目的（今回の整理のゴール）

- ドキュメントとコードの整合を取り、**現行の実運用フロー（CSV + 行ごとの WAV）** を SSOT として明確化。
- 直近の広域例外（`except Exception` / bare `except`）リファクタリングの成果を整理。
- 次の作業方針（複数案）と、実動作として何が期待されるかを「手触り感」まで落とし込む。
- 変更を `origin/master` へ反映し、作業再開可能な状態にする。

## 2. 現在のシステムの「実動作」期待（2025-12-14 時点）

### 2.1 主フロー（現行 SSOT: CSV + WAV）

入力:
- CSV（話者名 + テキスト）
- 音声ディレクトリ（`001.wav`, `002.wav` ...）

期待される出力:
- `data/videos/` に mp4
- `data/transcripts/` に SRT/VTT/ASS
- オプションで `data/ymm4/` に YMM4 プロジェクト出力（テンプレ差分適用＋補助JSON）
- サムネイル/メタデータも「APIなし」で生成可能（テンプレ/ルールベース）

実行手段:
- CLI: `scripts/run_csv_pipeline.py`
- Web UI: `src/web/web_app.py`（Streamlit）→ 「CSV Pipeline」ページ

SSOT:
- `docs/user_guide_manual_workflow.md`
- `docs/spec_csv_input_format.md`

### 2.2 全自動（NotebookLM/Gemini/Slides/YouTube）

- **概念・将来像としての設計が中心**で、現状は一部がモック/プレースホルダー。
- `docs/workflow_specification.md` は概念フローとして維持しつつ、冒頭に SSOT を明記して混乱を抑制。

## 3. 今回までに完了していること（重要）

### 3.1 例外処理リファクタリング（広域 except の解消/可視化）

- `src/` および `scripts/` 配下の **bare `except:` と「`except Exception` しかない try」** を全件再スキャンし、0 件であることを確認。
- 想定例外 → catch-all の順で分割し、**ログ文言・return/raise・フォールバック挙動は維持**。
- 特に `asyncio.CancelledError`（`BaseException` 系）を優先捕捉する箇所は先頭で再送出/扱いを統一。

テスト:
- `python -m pytest -q -m "not slow and not integration" --durations=20`
- 結果: **102 passed, 7 skipped, 4 deselected**

### 3.2 ドキュメント整備（導線/SSOT 明確化）

更新方針:
- `docs/INDEX.md` を入口にし、
  - 「SSOT」
  - 「セットアップ」
  - 「開発者向け」
  - 「履歴/スナップショット」
  を分離。

主な更新:
- `docs/INDEX.md`: SSOT と履歴を分離、セットアップ導線を追記。
- `docs/development_guide.md`: `master` ブランチの実態に合わせた表記/Windows コマンド例を補正。
- `README.md`: プレースホルダー URL の修正、`.env` 作成導線、OpenSpec ツールの引数齟齬を補正。
- `PYTHON_INSTALL_GUIDE.md`: 固定パスを `<repo_root>` に置換し、入口（README/README_SETUP）を明示。
- `FINAL_SETUP_GUIDE.md`: legacy 補助資料として位置づけを明確化し、固定パスを `<repo_root>` に置換。
- `docs/workflow_specification.md`: 概念フローであることと、SSOT（手動素材フロー/backlog）を冒頭に明記。

## 4. 未完了（未実装/未修正）総ざらい

### 4.1 NotebookLM 系（実API or 実ブラウザ自動化は未実装）

コード上の TODO（例）:
- `src/notebook_lm/audio_generator.py`
  - NotebookLM 風フローのアップロード/生成リクエスト/ステータス確認/URL取得が TODO。
- `src/notebook_lm/transcript_processor.py`
  - NotebookLM 音声アップロード/文字起こしが TODO。
- `src/notebook_lm/source_collector.py`
  - 自動検索（検索 API）が TODO。

期待される動作（現状）:
- API キーが無い場合や NotebookLM 実処理が無い場合、**フォールバック/プレースホルダー生成**で動作が継続する設計。

### 4.2 Google Slides 自動生成の「完全実装」

- `src/slides/slide_generator.py` に Selenium/Slides API による自動化 TODO が残る。
- 現状はモック/最小プロトタイプ＋エクスポート/フォールバックの組み合わせ。

### 4.3 YMM4 プラグインAPI（.NET）

- `ymm4-plugin/` は「ロード確認済みのスケルトン」
- `IVoicePlugin` / `ITextCompletionPlugin` の公開仕様が不足しており、
  - backlog 上は **保留**扱い（実装を推測で進めると破綻リスクが高い）

### 4.4 技術的負債（軽微・継続）

- Docstring/型ヒントの整備
- エラーハンドリング方針の統一（「どの層で握りつぶすか」「戻り値の契約」）

## 5. 次に進む方向性（重要判断: 3案比較）

### 案A: APIフェーズを前進（Gemini + 任意TTS を主軸に Stage1 を実用化）

- 利点:
  - 「CSV+WAV」を準備できないユーザーに対しても自動生成体験を提供できる。
  - `src/core/providers/script/gemini_provider.py` と `src/audio/tts_integration.py` が既に軸として使える。
- 懸念:
  - 外部APIのキー管理、レート制限、課金、失敗時UXが増える。
- 導入条件:
  - `docs/api_setup_guide.md` に沿った OAuth/キー設定ができること。

### 案B: CSV+WAV 主フローをさらに堅牢化（運用の完成度を上げる）

- 利点:
  - 外部依存が少なく、再現性が高い。
  - 実運用ユーザーの “失敗しない” 体験を最短で改善できる。
- 懸念:
  - 「全自動」の期待値とのギャップが残る（ただし docs で調整済み）。
- 導入条件:
  - 入力検証（CSV列/音声欠番/長文分割）や UI ガイドの更なる改善を優先。

### 案C: YMM4 自動化を前進（プラグイン仕様補完→実装）

- 利点:
  - ゆっくり系の実制作（GUI編集）と相性が良く、最終成果物の品質を上げやすい。
- 懸念:
  - 仕様不確実性が高い（現状の公開情報だけでは詰まる可能性）。
- 導入条件:
  - DLL リフレクション等で `IVoicePlugin` / `ITextCompletionPlugin` のメソッド情報を確定させる方針を取れること。

## 6. 作業再開のためのチェックリスト

- `docs/INDEX.md` を起点に必要ドキュメントへ到達できる
- スモークテスト: `python -m pytest -q -m "not slow and not integration" --durations=20`
- 動作確認（最短）:
  - `python scripts/generate_sample_audio.py`
  - `python scripts/run_csv_pipeline.py --csv samples/basic_dialogue/timeline.csv --audio-dir samples/basic_dialogue/audio --topic "sample"`

## 7. Git / 反映

- ブランチ: `master`（origin/master がデフォルト）
- 反映手順:
  - commit → `git push origin master`
  - push 後に `git status` が clean であることを確認
  - `git log -1` と `git ls-remote origin master` の SHA が一致することを確認
